# 浏览器中的页面

## 页面性能分析：利用chrome做web性能分析

### Chrome 开发者工具

它一共包含了 10 个功能面板，包括了 Elements、Console、Sources、NetWork、Performance、Memory、Application、Security、Audits 和 Layers

### 网络面板

网络面板由控制器、过滤器、抓图信息、时间线、详细列表和西撒在信息概要这六个区域组成

<img src="./panel.png" width="70%">

时间线面板

<img src="./timing.png" width="70%">

queuing, 排队中， 浏览器发起请求不会立即执行，需要进入队列中

- 页面的资源有优先级, 核心文件高优先级, 图片等文件低优先级
- 每个域名只有 6 个 TCP 链接, 超出须进入队列
- 网络进程为数据分配磁盘空间, 新的 HTTP 请求也要进入队列

排队完成后, 要发起连接的状态, 但是在发起连接前因为其他的原因, 导致连接推迟, 反映在 stalled 中

initial connection/SSL 阶段, 和服务器建立连接阶段, 包括建立 TCP 的时间

request sent 阶段, 和服务器建立连接之后, 网络进程会准备请求数据, 并将其发送给网络, 速度非常快, 通常不到 1ms

waiting (TTFB), 数据发送出去了, 等待接收服务器第一个字节的数据, 时间越短, 说明服务器响应快

content downing, 从第一个字节到所有数据接收的时间

## DOM树：JavaScript是如何影响DOM树构建的

### 什么是 DOM

DOM 的三个作用:

1. DOM 是生成页面的基础数据结构
2. 从 js 角度, DOM 提供一套接口用来更改页面结构
3. DOM 也是一道安全防线, 不安全的内容在解析阶段就拒之门外

### DOM 树如何生成

网络进程加载多少数据, HTML 解析器便解析多少数据

字节流转换为 DOM 需要三个阶段

1. 通过分词器将字节流转换为 Token
2. 第二和第三阶段同步进行的, 将 Token 解析为 DOM 节点, 并将 DOM 节点添加到 DOM 树中

### javascript 如何影响 DOM 生成

在解析 HTML 文件的时候, 如果遇到 script 标签, HTML 解析器会暂停, js 引擎会介入, 脚本执行完成后继续 HTML 解析

在执行 js 代码之前, 需要下载脚本, 这会阻塞 DOM 的解析

如果 js 脚本中没有操作 DOM 的相关代码, 可以设置为异步加载, 使用 async 和 defer 来标记

```js
//加载完成, 立即执行
<script async type="text/javascript" src='foo.js'></script>
//加载完成, 在 DOMcontentLoaded 后执行
<script defer type="text/javascript" src='foo.js'></script>
```

JavaScript 引擎在解析 JavaScript 之前，是不知道 JavaScript 是否操纵了 CSSOM 的，所以渲染引擎在遇到 JavaScript 脚本时，不管该脚本是否操纵了 CSSOM，都会执行 CSS 文件下载，解析操作，再执行 JavaScript 脚本。

## 渲染流水线：CSS如何影响首次加载时的白屏时间

渲染流水线示意图

<img src="./pipeline.png" width="70%">

### CSSOM

CSSOM 的作用

1. 提供给 js 操作样式表的能力
2. 为布局树的合成提供基础的样式信息

布局树的结构基本上就是复制 DOM 树的结构，不同之处在于 DOM 树中那些不需要显示的元素会被过滤掉

复制好基本的布局树结构之后，渲染引擎会为对应的 DOM 元素选择对应的样式信息，这个过程就是样式计算。样式计算完成之后，渲染引擎还需要计算布局树中每个元素对应的几何位置，这个过程就是计算布局

有外部引用的 CSS js 的渲染流水线

<img src="./pipeline2.png" width="70%">